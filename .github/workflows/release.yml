name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-26
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_26.2.app

      - name: Import certificate
        env:
          CERTIFICATE_P12: ${{ secrets.CERTIFICATE_P12 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          security create-keychain -p "" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 1800 "$KEYCHAIN_PATH"
          security unlock-keychain -p "" "$KEYCHAIN_PATH"
          echo "$CERTIFICATE_P12" | base64 --decode > "$RUNNER_TEMP/cert.p12"
          security import "$RUNNER_TEMP/cert.p12" \
            -k "$KEYCHAIN_PATH" \
            -P "$CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security
          security set-key-partition-list \
            -S apple-tool:,apple: \
            -s -k "" "$KEYCHAIN_PATH"
          security list-keychains -d user \
            -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')

      - name: Resolve packages
        run: |
          xcodebuild -resolvePackageDependencies \
            -project Mud.xcodeproj \
            -scheme Mud

      - name: Archive
        run: |
          xcodebuild archive \
            -project Mud.xcodeproj \
            -scheme Mud \
            -configuration Release \
            -archivePath "$RUNNER_TEMP/Mud.xcarchive" \
            CODE_SIGN_STYLE=Manual \
            "CODE_SIGN_IDENTITY=Developer ID Application" \
            DEVELOPMENT_TEAM=XVL2AFNXH5

      - name: Export
        run: |
          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/Mud.xcarchive" \
            -exportPath "$RUNNER_TEMP/export" \
            -exportOptionsPlist .github/ExportOptions.plist

      - name: Create DMG
        run: |
          brew install create-dmg
          create-dmg \
            --volname "Mud" \
            --window-size 600 400 \
            --icon-size 128 \
            --icon "Mud.app" 160 200 \
            --app-drop-link 440 200 \
            "$RUNNER_TEMP/Mud.dmg" \
            "$RUNNER_TEMP/export/Mud.app"

      - name: Notarize and staple
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          TEAM_ID: ${{ secrets.TEAM_ID }}
          NOTARY_PASSWORD: ${{ secrets.NOTARY_PASSWORD }}
        run: |
          xcrun notarytool submit "$RUNNER_TEMP/Mud.dmg" \
            --apple-id "$APPLE_ID" \
            --team-id "$TEAM_ID" \
            --password "$NOTARY_PASSWORD" \
            --wait --timeout 1200
          xcrun stapler staple "$RUNNER_TEMP/Mud.dmg"

      - name: Prepare release assets
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          cp "$RUNNER_TEMP/Mud.dmg" "Mud-${VERSION}.dmg"
          shasum -a 256 "Mud-${VERSION}.dmg" > "Mud-${VERSION}.dmg.sha256"

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          gh release create "$VERSION" \
            "Mud-${VERSION}.dmg" \
            "Mud-${VERSION}.dmg.sha256" \
            --title "Mud ${VERSION#v}" \
            --generate-notes

      - name: Clean up keychain
        if: always()
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          security delete-keychain "$KEYCHAIN_PATH" 2>/dev/null || true
