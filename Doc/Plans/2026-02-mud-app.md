Mud: Mark Up or Down
===============================================================================

A minimal, perfect Markdown preview app for macOS Sequoia+.


## Requirements summary

**Core:**

- GitHub-flavored Markdown rendering
- CSS styleable, syntax highlighting
- Auto-reload on file change, preserving scroll position
- Manual reload (Cmd+R)
- Space bar toggles Up/Down view with scroll sync
- Down view: centered column, syntax-highlighted Markdown source
- Lighting toggle: Auto / Bright / Dark (two-state: auto vs opposite)
- Multiple windows (one per file)
- Unified toolbar with toggle buttons
- Quit app when last window closes
- Remember window position/size per document
- Open Recent menu
- Link handling: anchors scroll, .md opens in app, others open in browser

**Additional:**

- Find in document (Cmd+F), works in both Up and Down views
- Find Next / Previous (Cmd+G / Cmd+Shift+G)
- Print support (Cmd+P), Open in Browser (Cmd+Shift+B)
- Zoom In / Zoom Out (Cmd+=, Cmd+-, Cmd+0) with independent levels for Up and
  Down views, persisted globally
- Fully sandboxed (App Store ready) -- not yet achieved


## Technical choices

| Component         | Choice                      | Rationale                                 |
| ----------------- | --------------------------- | ----------------------------------------- |
| GFM rendering     | swift-markdown              | Typed AST, visitor-based rendering        |
| Code highlighting | highlight.js via JSContext  | Server-side, no per-document JS payload   |
| Down highlighting | swift-markdown AST          | HTML table with syntax spans              |
| HTML display      | WKWebView                   | Native print/PDF, JS bridge               |
| File watching     | DispatchSource              | Kernel-level, efficient                   |
| Document handling | NSDocumentController        | Open Recent, proper File menu             |
| Window management | NSWindowController          | Full control, NSHostingView bridge        |
| View layer        | SwiftUI in NSHostingView    | Modern UI with AppKit integration         |
| Mode toggle       | Single WKWebView, HTML swap | Mode-specific HTML documents              |
| Lighting          | CSS + NSAppearance          | Instant, no page reload                   |
| View options      | ViewToggle → CSS classes    | Persisted toggles (column, line #s, wrap) |
| State observation | Combine                     | AppKit toolbar ↔ SwiftUI bridge           |
| Find              | Custom DOM walker (mud.js)  | Unified search in both modes              |


## Project structure

```
Mud/
├── Mud.xcodeproj
├── App/
│   ├── MudApp.swift              # @main, menus, AppState
│   ├── AppDelegate.swift         # Lifecycle, CLI mode detection
│   ├── DocumentController.swift  # NSDocumentController (no NSDocument)
│   ├── DocumentWindowController.swift  # Window, toolbar, Combine sinks
│   ├── DocumentContentView.swift # SwiftUI host (single WebView)
│   ├── WebView.swift             # WKWebView wrapper + navigation delegate
│   ├── OutlineSidebarView.swift  # Table of contents sidebar
│   ├── OutlineNode.swift         # Sidebar data model
│   ├── FindFeature.swift         # FindState, FindBar, search types
│   ├── FileWatcher.swift         # DispatchSource file monitoring
│   ├── CLIMode.swift             # CLI rendering and execution
│   ├── CLIInstaller.swift        # CLI tool installation UI
│   ├── LocalFileSchemeHandler.swift  # mud-asset: URL scheme
│   ├── Lighting.swift            # Lighting enum (auto/bright/dark)
│   ├── Mode.swift                # Mode enum (up/down)
│   ├── Theme.swift               # Theme enum (austere/blues/earthy/riot)
│   ├── ViewToggle.swift          # Persisted view toggles → CSS classes
│   ├── DeferMutation.swift       # Safe @Published mutation helper
│   ├── Info.plist
│   ├── Mud.entitlements
│   ├── Mud.icon/                 # App icon SVG source assets
│   └── Assets.xcassets/
├── Core/
│   ├── Package.swift             # swift-markdown
│   └── Sources/Core/
│       ├── MudCore.swift         # Public API namespace
│       ├── OutlineHeading.swift  # Heading model (Core ↔ App)
│       ├── Rendering/
│       │   ├── UpHTMLVisitor.swift
│       │   ├── DownHTMLVisitor.swift
│       │   ├── HTMLTemplate.swift
│       │   ├── MarkdownParser.swift
│       │   ├── SlugGenerator.swift
│       │   ├── HeadingExtractor.swift
│       │   ├── CodeHighlighter.swift
│       │   ├── ImageDataURI.swift
│       │   └── HTMLEscaping.swift
│       └── Resources/
│           ├── mud.css
│           ├── mud-up.css
│           ├── mud-down.css
│           ├── mud.js
│           ├── mud-up.js
│           ├── mud-down.js
│           ├── highlight.min.js
│           └── theme-*.css
└── Doc/
    ├── AGENTS.md
    ├── Plans/
    └── Guides/
```


## Architecture

**Document handling flow:**

```
App Launch
    └── AppDelegate installs DocumentController
            └── Opens file → creates DocumentWindowController
                    ├── NSWindow with toolbar (AppKit)
                    └── NSHostingView → DocumentContentView (SwiftUI)
                            └── WebView (single, mode switches HTML)
```

**State management:**

- `AppState` (singleton) -- `lighting`, `theme`, `modeInActiveTab`,
  `viewToggles`, zoom levels, `sidebarVisible`
- `DocumentState` (per-window) -- `mode`, action triggers, `outlineHeadings`,
  `scrollTarget`, owns `FindState`
- `FindState` -- visibility, search text, match info, query generation via
  Combine

**Communication patterns:**

- Menu commands → NotificationCenter (`.reloadDocument`, `.printDocument`,
  `.openInBrowser`)
- Menu commands → responder chain (`toggleMode`, `toggleLighting`,
  `performFindAction`, `findNext`, `findPrevious`)
- Zoom → NotificationCenter (`.zoomIn`, `.zoomOut`, `.actualSize`)
- Toolbar → direct state mutation on `AppState` / `DocumentState`
- State changes → Combine sinks in DocumentWindowController (appearance,
  toolbar icons, UserDefaults persistence)
- SwiftUI ↔ WebView → JavaScript bridge (`Mud.*` namespace)

**Mode toggle:** A single `WebView` displays both modes. `DocumentContentView`
computes `modeHTML` — calling `MudCore.renderUpModeDocument` for Up mode or
`MudCore.renderDownModeDocument` for Down mode — and passes it to the
`WebView`. Toggling mode swaps the entire HTML document.

**Find implementation:** `mud.js` DOM text walker wraps matches in `<mark>`
elements, tracks active match, scrolls into view. Supports incremental
refinement (prefix typing stays near current position) and directional advance
(Cmd+G / Cmd+Shift+G). Works identically in both modes.

**Link handling (JS click interceptor → `WKScriptMessageHandler`):**

- Anchor links (`#section`) → allowed natively (headings have IDs from
  `SlugGenerator`)
- All other clicks intercepted by `mud-up.js`, resolved to absolute URLs via
  `new URL(href, document.baseURI)`, posted to `mudOpen` handler
- Local `.md` /`.markdown` → open via `NSDocumentController`
- All other URLs → `NSWorkspace` (default browser/app)
- `decidePolicyFor` kept as safety net (allows page loads + anchor scrolls)

**Lighting toggle:** Two-state cycle: auto → opposite of current system
appearance → auto. CSS `data-lighting` attribute for instant web view update;
`NSWindow.appearance` for AppKit chrome. Persisted to UserDefaults.


## Progress

All features complete:

- [x] GFM rendering (cmark-gfm, highlight.js)
- [x] Auto-reload via DispatchSource (handles atomic saves)
- [x] Up/Down toggle with scroll sync
- [x] Down view: centered column, syntax-highlighted source
- [x] Lighting toggle with persistence
- [x] NSDocumentController + NSWindowController document handling
- [x] Open Recent, window frame save/restore
- [x] Find in both views (Cmd+F, Cmd+G, Cmd+Shift+G, `/`, Escape)
- [x] Print (Cmd+P), Open in Browser (Cmd+Shift+B)
- [x] Zoom with independent levels per mode, persisted
- [x] Link handling (anchors, local .md, external)
- [x] AutoFill menu item suppression
- [x] App icon (Icon Composer)


## Implementation notes

**Print:** Uses `WKWebView.printOperation(with:)` with `runModal(for:...)` (not
`run()` -- async pipeline gives blank pages). State-driven: menu posts
notification → DocumentContentView sets `printID` → WebView reacts in
`updateNSView`. Dead ends: `window.print()` (silent no-op), `printView(nil)`
(blank), `createPDF` (no pagination).

**Open in Browser:** Writes HTML to temp file, opens with default browser via
`NSWorkspace.shared.open([url], withApplicationAt:)` using
`urlForApplication(toOpen:)` with an `https:` URL (bypasses `.html` file
association).

**Window frame save/restore:** Manual UserDefaults in `windowWillClose` (not
`frameAutosaveName`). The built-in autosave doesn't persist reliably because
app terminates immediately on last window close.


## Key files

See `Doc/AGENTS.md` for the current file quick reference.


## Verification checklist

- [x] Open .md file, renders correctly
- [x] GFM features (tables, task lists, strikethrough, code blocks)
- [x] Edit externally, auto-reloads with scroll preserved
- [x] Manual reload (Cmd+R)
- [x] Space toggles Up/Down with scroll sync
- [x] Down view shows syntax-highlighted source in centered column
- [x] Lighting toggle (auto ↔ opposite)
- [x] Cmd+W closes window, app quits on last close
- [x] File → Open, File → Open Recent
- [x] Window position/size remembered
- [x] Double-click .md in Finder opens in Mud
- [x] Cmd+F find in Up view (with match count)
- [x] Cmd+F find in Down view
- [x] Cmd+G / Cmd+Shift+G find next/previous
- [x] Links: anchors, local .md, external
- [x] Print (Cmd+P)
- [x] Open in Browser (Cmd+Shift+B)
- [x] Zoom In/Out/Actual Size (independent per mode)
